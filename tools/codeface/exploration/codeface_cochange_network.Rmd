---
title: "Network analysis"
  html_document:
    toc: true
    number_sections: true
---

# Introduction

This notebook visualises the co-change networks extracted by Codeface during commit analysis.

As a prerequisite, Codeface must be run on the desired Git project to parse the git log and to construct the adjacency matrices based on entity (i.e. files, functions and features) changes or tagging information. The adjacency matrices stored in the **res** directory will serve as input for this notebook.

```{r message=FALSE}
require(RMySQL)
require(visNetwork)
require(data.table)
require(igraph)
require(network)
require(sna)
require(ggplot2)
require(RColorBrewer)
source("/home/nicole/Documents/SWE/Tools/codeface/exploration/plot.R")
```

## Configuration

The following lines define the project to analyse and the path to its result (**res**) directory containing the adjacency matrices. The visualisations generated in this notebook will be written to the corresponding result directory as well.

```{r}
res_dir <- file.path("/home/nicole/Documents/SWE/Analyses",
                     "codeface/res/example/proximity")
                     # "results_comparison/codeface/postgres/proximity")
```

A connection to the Codeface database has to be established to extract additional information such as person names and e-mail addresses. The following set up assumes the installation in a Docker container with the database port being mapped to another port on the host system.

```{r}
conn <- dbConnect(RMySQL::MySQL(),
                  dbname = "codeface",
                  host = "127.0.0.1",  # Should be used instead of "localhost"
                  port = 3308,  # Port 3306 (mysql in docker) is mapped to port 3308 on the host system
                  user = "codeface",
                  password = "codeface")
```

Get an overview on all available database tables.

```{r}
dbListTables(conn)
```


# Adjacency matrices

Preprocess the adjacency matrices of all time ranges and replace the authors' IDs by their name and e-mail-addresses to facilitate the comparison of the network structures generated by Codeface and those generated by other tools.

```{r}
# Get result directories for all time ranges
dirs <- list.dirs(res_dir)
dirs <- dirs[grepl("[0-9]", dirs)]

graphs <- list()

for (i in seq_along(dirs)) {
  # Load the adjacency matrix generated by Codeface
  # Column headers refer to author IDs
  df <- read.table(file.path(dirs[i], "adjacencyMatrix.txt"),
                   sep = "\t", header = TRUE, check.names = FALSE)
  
  # Transpose matrix to correspond to the common matrix notation
  persons <- colnames(df)
  df <- transpose(df)
  colnames(df) <- rownames(df) <- persons

  for (j in seq_along(rownames(df))) {
    # Replace each author's ID by its name and e-mail address
    query <- paste("select name, email1 from person where id =",
                    as.character(rownames(df)[j]))
    res <- dbGetQuery(conn, query)

    colnames(df)[j] <- rownames(df)[j] <- paste(res$name, " <",
                                                res$email1, ">", sep = "")
  }

  # Order rows and columns alphabetically
  if (nrow(df) > 1) {
    df <- df[order(rownames(df)),]
    df <- df[,order(colnames(df))]

    df <- df[, !(names(df) %in% c("GitHub <noreply@github.com>"))]
    df <- df[!(rownames(df) %in% c("GitHub <noreply@github.com>")),]
  }

  # Save the preprocessed adjacency matrix for further analyses
  write.csv(df, file.path(dirs[i], "adjacency_matrix.csv"), row.names=TRUE)

  # Only plot the collaboration network graph and the adjacency matrix if there
  # were several developers working on the project in the given time window
  matrix = data.matrix(df)

  if (nrow(matrix) > 1) {
    # Create a network plot from the adjacency matrix
    g <- igraph::graph_from_adjacency_matrix(matrix, mode = "directed", weighted = TRUE)
    g <- igraph::simplify(g, remove.multiple = TRUE, remove.loops = TRUE,
                          edge.attr.comb=list(weight="sum"))
    graphs[[i]] <- g

    # Plot the author collaboration network
    graph_to_pdf(g, dirs[i], "network_graph.pdf", igraph::is.directed(g))

    # Plot the adjacency matrix as a heatmap
    heatmap_to_pdf(matrix, dirs[i], "network_heatmap.pdf")
  }
}
```
```{r}
df
```

```{r}
# g <- igraph::graph_from_adjacency_matrix(data.matrix(adjacency_matrices[[0]]))
# visIgraph(g)
```

